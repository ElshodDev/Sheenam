@page "/"
@page "/dashboard"
@using Sheenam.Api.Models.Foundations.HomeRequests
@using Sheenam.Blazor.Models.Foundations.Hosts
@using Sheenam.Blazor.Models.Foundations.Homes
@using Sheenam.Blazor.Models.Foundations.Guests
@using Sheenam.Blazor.Models.Foundations.HomeRequests
@using System.Net.Http.Json
@inject HttpClient HttpClient
@inject NavigationManager Nav

<PageTitle>Dashboard - Sheenam</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div>
                <h1 class="dashboard-title">
                    <span class="title-icon">📊</span>
                    Dashboard
                </h1>
                <p class="dashboard-subtitle">Umumiy ma'lumotlar va statistika</p>
            </div>
            <button class="btn-refresh" @onclick="LoadData">
                <span class="refresh-icon">🔄</span>
                <span>Yangilash</span>
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-grid">
            @for (int i = 0; i < 4; i++)
            {
                <div class="skeleton-card"></div>
            }
        </div>
    }
    else
    {
        <!-- Statistika kartochkalari -->
        <div class="stats-grid">
            <!-- Hosts -->
            <div class="stat-card stat-card-success">
                <div class="stat-card-header">
                    <div class="stat-content">
                        <span class="stat-label">Uy egalari</span>
                        <h2 class="stat-value">@hosts.Count</h2>
                        <span class="stat-trend">📈 Faol</span>
                    </div>
                    <div class="stat-icon">
                        <span>👨‍💼</span>
                    </div>
                </div>
                <button class="stat-action" @onclick='() => Nav.NavigateTo("/hosts")'>
                    Batafsil ko'rish
                    <span>→</span>
                </button>
            </div>

            <!-- Homes -->
            <div class="stat-card stat-card-primary">
                <div class="stat-card-header">
                    <div class="stat-content">
                        <span class="stat-label">Uylar</span>
                        <h2 class="stat-value">@homes.Count</h2>
                        <span class="stat-trend">🏠 Bo'sh: @vacantHomes</span>
                    </div>
                    <div class="stat-icon">
                        <span>🏡</span>
                    </div>
                </div>
                <button class="stat-action" @onclick='() => Nav.NavigateTo("/homes")'>
                    Batafsil ko'rish
                    <span>→</span>
                </button>
            </div>

            <!-- Guests -->
            <div class="stat-card stat-card-info">
                <div class="stat-card-header">
                    <div class="stat-content">
                        <span class="stat-label">Mehmonlar</span>
                        <h2 class="stat-value">@guests.Count</h2>
                        <span class="stat-trend">👥 Ro'yxatdan o'tgan</span>
                    </div>
                    <div class="stat-icon">
                        <span>👥</span>
                    </div>
                </div>
                <button class="stat-action" @onclick='() => Nav.NavigateTo("/guests")'>
                    Batafsil ko'rish
                    <span>→</span>
                </button>
            </div>

            <!-- Home Requests -->
            <div class="stat-card stat-card-warning">
                <div class="stat-card-header">
                    <div class="stat-content">
                        <span class="stat-label">So'rovlar</span>
                        <h2 class="stat-value">@homeRequests.Count</h2>
                        <span class="stat-trend">✉️ Yangi so'rovlar</span>
                    </div>
                    <div class="stat-icon">
                        <span>📨</span>
                    </div>
                </div>
                <button class="stat-action" @onclick='() => Nav.NavigateTo("/home-requests")'>
                    Batafsil ko'rish
                    <span>→</span>
                </button>
            </div>
        </div>

        <!-- Qo'shimcha statistika - Katta kartochkalar -->
        <div class="metrics-grid">
            <div class="metric-card metric-card-gold">
                <div class="metric-icon">💰</div>
                <div class="metric-content">
                    <span class="metric-label">O'rtacha narx</span>
                    <h3 class="metric-value">@averagePrice.ToString("N0") so'm</h3>
                    <span class="metric-hint">kecha uchun</span>
                </div>
            </div>

            <div class="metric-card metric-card-blue">
                <div class="metric-icon">📏</div>
                <div class="metric-content">
                    <span class="metric-label">Umumiy maydon</span>
                    <h3 class="metric-value">@totalArea.ToString("N0") m²</h3>
                    <span class="metric-hint">barcha uylar</span>
                </div>
            </div>

            <div class="metric-card metric-card-purple">
                <div class="metric-icon">📊</div>
                <div class="metric-content">
                    <span class="metric-label">Bo'sh uylar</span>
                    <h3 class="metric-value">@vacancyRate%</h3>
                    <span class="metric-hint">@vacantHomes / @homes.Count ta</span>
                </div>
            </div>
        </div>

        <!-- Oxirgi so'rovlar jadval -->
        <div class="requests-section">
            <div class="section-header">
                <div>
                    <h3 class="section-title">📋 Oxirgi so'rovlar</h3>
                    <p class="section-subtitle">Eng yangi kiruvchi so'rovlar</p>
                </div>
                <button class="btn-view-all" @onclick='() => Nav.NavigateTo("/home-requests")'>
                    Barchasini ko'rish
                    <span>→</span>
                </button>
            </div>

            @if (recentRequests.Any())
            {
                <div class="requests-table">
                    <div class="table-header">
                        <div class="table-cell">Mehmon</div>
                        <div class="table-cell">Uy</div>
                        <div class="table-cell">Boshlanish</div>
                        <div class="table-cell">Tugash</div>
                        <div class="table-cell">Xabar</div>
                    </div>
                    @foreach (var req in recentRequests)
                    {
                        var guest = guests.FirstOrDefault(g => g.Id == req.GuestId);
                        var home = homes.FirstOrDefault(h => h.Id == req.HomeId);
                        <div class="table-row">
                            <div class="table-cell">
                                <div class="user-info">
                                    <div class="user-avatar">@((guest?.FirstName ?? "?")[0])</div>
                                    <span class="user-name">@(guest?.FirstName ?? "Noma'lum") @(guest?.LastName ?? "")</span>
                                </div>
                            </div>
                            <div class="table-cell">
                                <span class="address-text">@(home?.Address ?? "—")</span>
                            </div>
                            <div class="table-cell">
                                <span class="date-badge">@req.StartDate.ToString("dd.MM.yyyy")</span>
                            </div>
                            <div class="table-cell">
                                <span class="date-badge">@req.EndDate.ToString("dd.MM.yyyy")</span>
                            </div>
                            <div class="table-cell">
                                <span class="message-text">
                                    @(string.IsNullOrEmpty(req.Message) ? "—" : req.Message.Substring(0, Math.Min(40, req.Message.Length)) + "...")
                                </span>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <span class="empty-icon">📭</span>
                    <h4>Hozircha so'rovlar yo'q</h4>
                    <p>Yangi so'rovlar kelganda bu yerda ko'rinadi</p>
                </div>
            }
        </div>

        <!-- Tezkor havolalar -->
        <div class="quick-actions">
            <h3 class="section-title">⚡ Tezkor harakatlar</h3>
            <div class="actions-grid">
                <div class="action-card" @onclick='() => Nav.NavigateTo("/hosts")'>
                    <div class="action-icon">👨‍💼</div>
                    <h4 class="action-title">Yangi Host</h4>
                    <p class="action-desc">Uy egasini qo'shish</p>
                </div>
                <div class="action-card" @onclick='() => Nav.NavigateTo("/homes")'>
                    <div class="action-icon">🏠</div>
                    <h4 class="action-title">Yangi Uy</h4>
                    <p class="action-desc">Uy qo'shish</p>
                </div>
                <div class="action-card" @onclick='() => Nav.NavigateTo("/guests")'>
                    <div class="action-icon">👤</div>
                    <h4 class="action-title">Yangi Mehmon</h4>
                    <p class="action-desc">Mehmon qo'shish</p>
                </div>
                <div class="action-card" @onclick='() => Nav.NavigateTo("/home-requests")'>
                    <div class="action-icon">📩</div>
                    <h4 class="action-title">Yangi So'rov</h4>
                    <p class="action-desc">So'rov yaratish</p>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Container */
    .dashboard-container {
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Header */
    .dashboard-header {
        margin-bottom: 2rem;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .dashboard-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .title-icon {
        font-size: 2.5rem;
    }

    .dashboard-subtitle {
        margin: 0.5rem 0 0;
        color: #6b7280;
        font-size: 1.1rem;
    }

    .btn-refresh {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

    .refresh-icon {
        font-size: 1.2rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 20px;
        padding: 1.75rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

    .stat-card-success::before {
        background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }

    .stat-card-primary::before {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card-info::before {
        background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
    }

    .stat-card-warning::before {
        background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        display: block;
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        color: #1f2937;
    }

    .stat-trend {
        display: inline-block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .stat-icon {
        font-size: 3.5rem;
        opacity: 0.2;
    }

    .stat-action {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .stat-action:hover {
            background: rgba(102, 126, 234, 0.2);
        }

    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s ease;
    }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

    .metric-icon {
        font-size: 4rem;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
    }

    .metric-label {
        display: block;
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 800;
        margin: 0 0 0.25rem;
        color: #1f2937;
    }

    .metric-hint {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .metric-card-gold {
        border-left: 4px solid #f59e0b;
    }

    .metric-card-blue {
        border-left: 4px solid #3b82f6;
    }

    .metric-card-purple {
        border-left: 4px solid #667eea;
    }

    /* Requests Section */
    .requests-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: #1f2937;
    }

    .section-subtitle {
        margin: 0.25rem 0 0;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .btn-view-all {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-view-all:hover {
            background: rgba(102, 126, 234, 0.2);
        }

    /* Table */
    .requests-table {
        overflow-x: auto;
    }

    .table-header, .table-row {
        display: grid;
        grid-template-columns: 2fr 2fr 1.5fr 1.5fr 3fr;
        gap: 1rem;
        padding: 1rem;
        align-items: center;
    }

    .table-header {
        background: #f9fafb;
        border-radius: 12px;
        font-weight: 600;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .table-row {
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.3s ease;
    }

        .table-row:hover {
            background: #f9fafb;
        }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .user-name {
        font-weight: 600;
        color: #1f2937;
    }

    .address-text {
        color: #6b7280;
    }

    .date-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: #f3f4f6;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #374151;
        font-weight: 500;
    }

    .message-text {
        color: #9ca3af;
        font-size: 0.9rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-icon {
        font-size: 5rem;
        display: block;
        margin-bottom: 1rem;
    }

    .empty-state h4 {
        font-size: 1.5rem;
        margin: 0 0 0.5rem;
        color: #1f2937;
    }

    .empty-state p {
        color: #6b7280;
        margin: 0;
    }

    /* Quick Actions */
    .quick-actions {
        margin-top: 2rem;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .action-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            border-color: #667eea;
        }

    .action-icon {
        font-size: 3.5rem;
        margin-bottom: 1rem;
    }

    .action-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 0.5rem;
        color: #1f2937;
    }

    .action-desc {
        margin: 0;
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* Loading */
    .loading-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .skeleton-card {
        height: 200px;
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
        border-radius: 20px;
    }

    @@keyframes loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .dashboard-container {
            padding: 1rem;
        }

        .dashboard-title {
            font-size: 2rem;
        }

        .table-header, .table-row {
            grid-template-columns: 1fr;
        }

        .stats-grid, .metrics-grid, .actions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private List<Host> hosts = new();
    private List<Home> homes = new();
    private List<Guest> guests = new();
    private List<HomeRequest> homeRequests = new();
    private List<HomeRequest> recentRequests = new();

    private int vacantHomes = 0;
    private decimal averagePrice = 0;
    private double totalArea = 0;
    private int vacancyRate = 0;

    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            // Parallel yuklash - tezroq
            var hostsTask = HttpClient.GetFromJsonAsync<List<Host>>("api/Hosts");
            var homesTask = HttpClient.GetFromJsonAsync<List<Home>>("api/Homes");
            var guestsTask = HttpClient.GetFromJsonAsync<List<Guest>>("api/Guests");
            var requestsTask = HttpClient.GetFromJsonAsync<List<HomeRequest>>("api/HomeRequests");

            await Task.WhenAll(hostsTask, homesTask, guestsTask, requestsTask);

            hosts = await hostsTask ?? new();
            homes = await homesTask ?? new();
            guests = await guestsTask ?? new();
            homeRequests = await requestsTask ?? new();

            // Statistikani hisoblash
            CalculateStats();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard xato: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalculateStats()
    {
        // Bo'sh uylar
        vacantHomes = homes.Count(h => h.IsVacant);

        // O'rtacha narx
        if (homes.Any())
        {
            averagePrice = homes.Average(h => h.Price);
        }

        // Umumiy maydon
        totalArea = homes.Sum(h => h.Area);

        // Bo'sh uylar foizi
        if (homes.Any())
        {
            vacancyRate = (int)((double)vacantHomes / homes.Count * 100);
        }

        recentRequests = homeRequests
            .OrderByDescending(r => r.CreatedDate)
            .Take(5)
            .ToList();
    }
}