@page "/home-requests"
@attribute [Authorize]
@using Sheenam.Api.Models.Foundations.HomeRequests
@using Sheenam.Blazor.Models.Foundations.HomeRequests
@using Sheenam.Blazor.Services
@inject HomeRequestService HomeRequestService

<PageTitle>Uy so'rovlari - Sheenam</PageTitle>

<div class="container my-5">
    <h1 class="text-center mb-5 display-5 fw-bold text-indigo">
        🏠 Uy so'rovlari boshqaruvi
    </h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>❌ Xato:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✅ Muvaffaqiyatli! </strong> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    <!-- Filter va Refresh -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold text-indigo">Status bo'yicha filter:</label>
            <select class="form-select" @bind="selectedStatusFilter" @bind:after="OnFilterChanged">
                <option value="">Barchasi</option>
                <option value="Pending">🟡 Kutilmoqda</option>
                <option value="Approved">🟢 Tasdiqlangan</option>
                <option value="Rejected">🔴 Rad etilgan</option>
                <option value="Cancelled">⚫ Bekor qilingan</option>
            </select>
        </div>
        <div class="col-md-8 text-end">
            <button class="btn btn-indigo btn-lg px-4" @onclick="LoadData">
                🔄 Yangilash
            </button>
        </div>
    </div>

    <!-- So'rovlar ro'yxati -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-indigo" style="width: 4rem; height: 4rem;"></div>
            <p class="mt-3 text-muted">Ma'lumotlar yuklanmoqda...</p>
        </div>
    }
    else if (requests.Count == 0)
    {
        <div class="alert alert-info text-center fs-4 p-5 rounded shadow">
            📭 Hozircha hech qanday so'rov yo'q.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-lg rounded overflow-hidden">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-indigo text-white">
                    <tr>
                        <th>#</th>
                        <th>Mehmon ID</th>
                        <th>Uy ID</th>
                        <th>Xabar</th>
                        <th>Boshlanish</th>
                        <th>Tugash</th>
                        <th>Status</th>
                        <th>Rad etish sababi</th>
                        <th>Amallar</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var (req, i) in requests.Select((r, idx) => (r, idx)))
                    {
                        <tr class="hover-row">
                            <td class="fw-bold">@(i + 1)</td>
                            <td><small>@req.GuestId. ToString().Substring(0, 8)...</small></td>
                            <td><small>@req.HomeId.ToString().Substring(0, 8)...</small></td>
                            <td>@(string.IsNullOrEmpty(req.Message) ? "—" : req.Message)</td>
                            <td>@req.StartDate.ToString("dd.MM.yyyy")</td>
                            <td>@req.EndDate.ToString("dd.MM. yyyy")</td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(req.Status) fs-6 px-3 py-2">
                                    @GetStatusIcon(req.Status) @GetStatusText(req.Status)
                                </span>
                            </td>
                            <td>@(req.RejectionReason ?? "—")</td>
                            <td>
                                @if (req.Status == HomeRequestStatus.Pending)
                                {
                                    <button class="btn btn-sm btn-success me-1" @onclick="() => ApproveRequest(req.Id)">
                                        ✅ Tasdiqlash
                                    </button>
                                    <button class="btn btn-sm btn-danger me-1" @onclick="() => ShowRejectModal(req.Id)">
                                        ❌ Rad etish
                                    </button>
                                    <button class="btn btn-sm btn-secondary" @onclick="() => CancelRequest(req.Id)">
                                        🚫 Bekor qilish
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted">Amallar yo'q</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="text-center mt-4">
            <small class="text-muted">
                Jami:  <strong class="text-indigo">@requests.Count</strong> ta so'rov
            </small>
        </div>
    }
</div>

<!-- Reject Modal -->
@if (showRejectModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">❌ So'rovni rad etish</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseRejectModal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label fw-bold">Rad etish sababi (ixtiyoriy):</label>
                    <textarea class="form-control" rows="4" @bind="rejectionReason"
                              placeholder="Masalan:  Uy band, sanalar mos kelmaydi... "></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseRejectModal">Yopish</button>
                    <button class="btn btn-danger" @onclick="ConfirmReject">Rad etish</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .text-indigo {
        color: #6366f1;
    }

    .bg-indigo {
        background-color: #6366f1;
    }

    .btn-indigo {
        background-color: #6366f1;
        border-color: #6366f1;
        color: white;
    }

        .btn-indigo:hover {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }

    .hover-row:hover {
        background-color: #f8f9ff;
    }

    .badge {
        font-weight: 600;
    }
</style>

@code {
    private List<HomeRequest> requests = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;
    private bool showRejectModal = false;
    private Guid selectedRequestId;
    private string rejectionReason = string.Empty;
    private string selectedStatusFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            successMessage = null;

            requests = await HomeRequestService.GetAllHomeRequestsAsync() ?? new();
            successMessage = $"{requests.Count} ta so'rov yuklandi";
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"API bilan bog'lanishda xato: {ex.Message}";
            requests = new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Kutilmagan xato: {ex.Message}";
            requests = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChanged()
    {
        if (string.IsNullOrEmpty(selectedStatusFilter))
        {
            await LoadData();
        }
        else if (Enum.TryParse<HomeRequestStatus>(selectedStatusFilter, out var status))
        {
            try
            {
                isLoading = true;
                errorMessage = null;
                requests = await HomeRequestService.GetHomeRequestsByStatusAsync(status) ?? new();
                successMessage = $"{requests.Count} ta {GetStatusText(status)} so'rov topildi";
            }
            catch (Exception ex)
            {
                errorMessage = $"Filtrlashda xato: {ex.Message}";
            }
            finally
            {
                isLoading = false;
            }
        }
    }

    private async Task ApproveRequest(Guid id)
    {
        try
        {
            errorMessage = null;
            await HomeRequestService.ApproveHomeRequestAsync(id);
            successMessage = "So'rov tasdiqlandi! ";
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Tasdiqlashda xato: {ex.Message}";
        }
    }

    private void ShowRejectModal(Guid id)
    {
        selectedRequestId = id;
        rejectionReason = string.Empty;
        showRejectModal = true;
    }

    private void CloseRejectModal()
    {
        showRejectModal = false;
        rejectionReason = string.Empty;
    }

    private async Task ConfirmReject()
    {
        try
        {
            errorMessage = null;
            await HomeRequestService.RejectHomeRequestAsync(selectedRequestId, rejectionReason);
            successMessage = "So'rov rad etildi!";
            await LoadData();
            CloseRejectModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Rad etishda xato: {ex.Message}";
        }
    }

    private async Task CancelRequest(Guid id)
    {
        try
        {
            errorMessage = null;
            await HomeRequestService.CancelHomeRequestAsync(id);
            successMessage = "So'rov bekor qilindi! ";
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Bekor qilishda xato: {ex.Message}";
        }
    }

    private string GetStatusBadgeClass(HomeRequestStatus status) => status switch
    {
        HomeRequestStatus.Pending => "bg-warning text-dark",
        HomeRequestStatus.Approved => "bg-success text-white",
        HomeRequestStatus.Rejected => "bg-danger text-white",
        HomeRequestStatus.Cancelled => "bg-secondary text-white",
        _ => "bg-secondary text-white"
    };

    private string GetStatusIcon(HomeRequestStatus status) => status switch
    {
        HomeRequestStatus.Pending => "🟡",
        HomeRequestStatus.Approved => "🟢",
        HomeRequestStatus.Rejected => "🔴",
        HomeRequestStatus.Cancelled => "⚫",
        _ => "❓"
    };

    private string GetStatusText(HomeRequestStatus status) => status switch
    {
        HomeRequestStatus.Pending => "Kutilmoqda",
        HomeRequestStatus.Approved => "Tasdiqlangan",
        HomeRequestStatus.Rejected => "Rad etilgan",
        HomeRequestStatus.Cancelled => "Bekor qilingan",
        _ => "Noma'lum"
    };
}